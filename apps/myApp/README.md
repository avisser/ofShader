# ofShader (myApp)

## Pipeline
- **Input**: Webcam via `ofVideoGrabber` at the configured resolution/FPS.
- **Update**:
  - Motion analysis (`updateMotion`) samples a live color for spark particles.
  - Vision face detection runs every few frames and caches face bounds.
  - Vision hand pose detection tracks fingertips for sparkles.
  - If shader mode is **off** (`2`), OpenCV MOG2 builds a background mask (threshold + morph + blur).
- **Draw**:
  - Background image (`bg.jpg`) or a flat gray fallback.
  - Foreground:
    - **Shader mode** (`1`): webcam texture → optional kaleidoscope/halftone → woofer distortion (beat‑synced) → HSV key → posterize + edge boost → optional hue‑pulse → optional saturation → wet/dry mix → alpha output.
    - **BG‑sub mode** (`2`): composited RGBA mask from MOG2.
  - Face debug overlay (cyan rectangles).
  - Hand sparkles (directional sparkler particles from fingertips).

## Key Bindings
- `1` Shader key mode (HSV key + stylize).
- `2` Background subtractor mode (OpenCV MOG2).
- `k` Cycle kaleidoscope modes (off → 4 → 6 → 8 → 10 → 12 → off).
- `Shift+K` Enter MIDI learn mode for kaleidoscope (first pad/knob binds).
- `Cmd+Shift+K` Enter MIDI learn for a kaleidoscope mute pad (pad-only, hold to mute).
- `Cmd+Opt+K` or `Ctrl+Shift+Cmd+K` or `Ctrl+Shift+Opt+K` Enter MIDI learn for kaleidoscope oscillator (pad toggles, knob sets speed).
- `z` Cycle kaleidoscope zoom (0.9 → 0.7 → 0.5).
- `Shift+Z` Enter MIDI learn mode for kaleidoscope zoom (first pad/knob binds).
- `Cmd+Shift+Z` Enter MIDI learn for a kaleidoscope zoom mute pad (pad-only, hold to mute).
- `Cmd+Opt+Z` or `Ctrl+Shift+Cmd+Z` or `Ctrl+Shift+Opt+Z` Enter MIDI learn for kaleidoscope zoom oscillator (pad toggles, knob sets speed).
- `d` Cycle halftone dots (off → fine → medium → coarse → off).
- `Shift+D` Enter MIDI learn mode for halftone (first pad/knob binds).
- `Cmd+Shift+D` Enter MIDI learn for a halftone mute pad (pad-only, hold to mute).
- `Cmd+Opt+D` or `Ctrl+Shift+Cmd+D` or `Ctrl+Shift+Opt+D` Enter MIDI learn for halftone oscillator (pad toggles, knob sets speed).
- `v` Cycle saturation presets (off → 0.2 → 0.45 → 0.7 → 0.9 → off).
- `Shift+V` Enter MIDI learn mode for saturation (first pad/knob binds).
- `Cmd+Shift+V` Enter MIDI learn for a saturation mute pad (pad-only, hold to mute).
- `Cmd+Opt+V` or `Ctrl+Shift+Cmd+V` or `Ctrl+Shift+Opt+V` Enter MIDI learn for saturation oscillator (pad toggles, knob sets speed).
- `t` Cycle tempo (60 → 80 → 100 → 120).
- `Shift+T` Enter MIDI learn mode for tempo (first pad/knob binds).
- `Cmd+Shift+T` Enter MIDI learn for a tempo mute pad (pad-only, hold to mute).
- `Cmd+Opt+T` or `Ctrl+Shift+Cmd+T` or `Ctrl+Shift+Opt+T` Enter MIDI learn for tempo oscillator (pad toggles, knob sets speed).
- `w` Cycle wet mix presets (0.2 → 0.4 → 0.6 → 0.8).
- `Shift+W` Enter MIDI learn mode for wet mix (first pad/knob binds).
- `Cmd+Shift+W` Enter MIDI learn for a wet mix mute pad (pad-only, hold to mute).
- `Cmd+Opt+W` or `Ctrl+Shift+Cmd+W` or `Ctrl+Shift+Opt+W` Enter MIDI learn for wet mix oscillator (pad toggles, knob sets speed).
- `b` Cycle woofer distortion (off → on → on → off).
- `?` Toggle on-screen help overlay (any key hides it).
- `p` Cycle MIDI input ports.
- `o` Toggle MIDI test output (random Note On + CC).
- `r` Reset background model.
- `e` Toggle morph (bg‑sub mode).
- `s` Toggle shadow detection (bg‑sub mode).
- `+` / `-` Adjust mask threshold (bg‑sub mode).
- `[` / `]` Previous/next camera device.
- `f` Toggle fullscreen.
- `Esc` Quit.

## Handy Tweaks (in `src/ofApp.h`)
- Green key: `keyHueDeg`, `keyHueRangeDeg`, `keyMinSat`, `keyMinVal`
- Stylize: `posterizeLevels`, `edgeStrength`
- Saturation: `saturationScale`
- Wet mix: `wetMix` (0 = raw camera, 1 = fully processed)
- Kaleidoscope: `kaleidoSegments`, `kaleidoSpin`
- Kaleidoscope framing: `kaleidoZoom` (lower = use more center)
- Halftone: `halftoneScale`, `halftoneEdge`
- Hue pulse: `pulseBpm`, `pulseHueShiftDeg`
- Woofer: `wooferStrength`, `wooferFalloff`
- Spark trails: `trailFade`
- Face detect: `faceDetectScale`, `faceDetectInterval`, `showFaceDebug`
- Hand detect: `handDetectScale`, `handDetectInterval`, `showHandDebug`, `handSparkleSize`, `handSparkleOpacity`
- Hand finger selection: `handSparkleFingers` (thumb, index, middle, ring, pinky)

## MIDI
- Uses `ofxMidi` for input.
- Learn: press `Shift+K`, then move a knob (CC flood) or hit a pad (NoteOn).
- Mute learn: press `Cmd+Shift+K`, then hit a pad. While that pad is held, the control is forced to the minimum knob value; releasing restores the previous value.
- Oscillator learn: press `Cmd+Opt+K` (or `Ctrl+Shift+Cmd+K` / `Ctrl+Shift+Opt+K`), then hit a pad or move a knob. The pad toggles the oscillator on/off. The knob sets the speed: 0 = off, 1 = 4 measures, 127 = quarter‑note cycles.
- Pad binding: cycles kaleidoscope modes.
- Knob binding: sets `kaleidoSegments` continuously (0..16), overriding the cycle.
- Learn kaleido zoom: press `Shift+Z`, then move a knob (CC flood) or hit a pad (NoteOn).
- Kaleido zoom pad: cycles zoom presets.
- Kaleido zoom knob: sets zoom continuously (1.0 → 0.3).
- Learn halftone: press `Shift+D`, then move a knob (CC flood) or hit a pad (NoteOn).
- Halftone pad: cycles the 4 presets.
- Halftone knob: sets `halftoneScale` continuously (wider range than presets).
- Learn saturation: press `Shift+V`, then move a knob (CC flood) or hit a pad (NoteOn).
- Saturation pad: cycles the 4 presets plus off.
- Saturation knob: sets saturation continuously (0 = B/W, 1 = full color).
- Learn tempo: press `Shift+T`, then move a knob (CC flood) or hit a pad (NoteOn).
- Tempo pad: cycles tempo presets.
- Tempo knob: sets BPM continuously (60 → 120).
- Learn wet mix: press `Shift+W`, then move a knob (CC flood) or hit a pad (NoteOn).
- Wet mix pad: cycles 20/40/60/80% wet.
- Wet mix knob: sets wet continuously (0 → 100%).
- Settings are persisted to `bin/data/settings.yaml` and loaded on startup. The device name is matched against available MIDI ports; a warning is logged if no match is found.
